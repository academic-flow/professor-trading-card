{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/phatca/Documents/GitHub/professor-trading-card/app/packages/montiapm:agent/lib/models/system.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.x86_64"},"sourceFileName":"packages/montiapm:agent/lib/models/system.js","filename":"/Users/phatca/Documents/GitHub/professor-trading-card/app/packages/montiapm:agent/lib/models/system.js","targets":{},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/phatca/Documents/GitHub/professor-trading-card/app","root":"/Users/phatca/Documents/GitHub/professor-trading-card/app","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/phatca/Documents/GitHub/professor-trading-card/app/packages/montiapm:agent/lib/models/system.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"packages/montiapm:agent/lib/models/system.js"}},"code":"module.export({\n  SystemModel: () => SystemModel\n});\nlet _;\nmodule.link(\"meteor/underscore\", {\n  _(v) {\n    _ = v;\n  }\n}, 0);\nlet Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n}, 1);\nlet countKeys, createHistogram;\nmodule.link(\"../utils.js\", {\n  countKeys(v) {\n    countKeys = v;\n  },\n  createHistogram(v) {\n    createHistogram = v;\n  }\n}, 2);\nlet GCMetrics;\nmodule.link(\"../hijack/gc.js\", {\n  default(v) {\n    GCMetrics = v;\n  }\n}, 3);\nlet getFiberMetrics, resetFiberMetrics;\nmodule.link(\"../hijack/async.js\", {\n  getFiberMetrics(v) {\n    getFiberMetrics = v;\n  },\n  resetFiberMetrics(v) {\n    resetFiberMetrics = v;\n  }\n}, 4);\nlet getMongoDriverStats, resetMongoDriverStats;\nmodule.link(\"../hijack/mongo_driver_events.js\", {\n  getMongoDriverStats(v) {\n    getMongoDriverStats = v;\n  },\n  resetMongoDriverStats(v) {\n    resetMongoDriverStats = v;\n  }\n}, 5);\nlet KadiraModel;\nmodule.link(\"./0model\", {\n  KadiraModel(v) {\n    KadiraModel = v;\n  }\n}, 6);\nlet EventLoopMonitor;\nmodule.link(\"../event_loop_monitor.js\", {\n  EventLoopMonitor(v) {\n    EventLoopMonitor = v;\n  }\n}, 7);\nlet Ntp;\nmodule.link(\"../ntp\", {\n  Ntp(v) {\n    Ntp = v;\n  }\n}, 8);\nfunction SystemModel() {\n  this.startTime = Ntp._now();\n  this.newSessions = 0;\n  // 30 min\n  this.sessionTimeout = 1000 * 60 * 30;\n  this.evloopHistogram = createHistogram();\n  this.evloopMonitor = new EventLoopMonitor(200);\n  this.evloopMonitor.start();\n  this.evloopMonitor.on('lag', lag => {\n    // store as microsecond\n    this.evloopHistogram.add(lag * 1000);\n  });\n  this.gcMetrics = new GCMetrics();\n  this.gcMetrics.start();\n  this.cpuTime = process.hrtime();\n  this.previousCpuUsage = process.cpuUsage();\n  this.cpuHistory = [];\n  this.currentCpuUsage = 0;\n  setInterval(() => {\n    this.cpuUsage();\n  }, 2000);\n}\n_.extend(SystemModel.prototype, KadiraModel.prototype);\nSystemModel.prototype.buildPayload = function () {\n  let metrics = {};\n  let now = Ntp._now();\n  metrics.startTime = Kadira.syncedDate.syncTime(this.startTime);\n  metrics.endTime = Kadira.syncedDate.syncTime(now);\n  metrics.sessions = countKeys(Meteor.server.sessions);\n  let memoryUsage = process.memoryUsage();\n  metrics.memory = memoryUsage.rss / (1024 * 1024);\n  metrics.memoryArrayBuffers = (memoryUsage.arrayBuffers || 0) / (1024 * 1024);\n  metrics.memoryExternal = memoryUsage.external / (1024 * 1024);\n  metrics.memoryHeapUsed = memoryUsage.heapUsed / (1024 * 1024);\n  metrics.memoryHeapTotal = memoryUsage.heapTotal / (1024 * 1024);\n  metrics.newSessions = this.newSessions;\n  this.newSessions = 0;\n  metrics.activeRequests = process._getActiveRequests().length;\n  metrics.activeHandles = process._getActiveHandles().length;\n\n  // track eventloop metrics\n  metrics.pctEvloopBlock = this.evloopMonitor.status().pctBlock;\n  metrics.evloopHistogram = this.evloopHistogram;\n  this.evloopHistogram = createHistogram();\n  metrics.gcMajorDuration = this.gcMetrics.metrics.gcMajor;\n  metrics.gcMinorDuration = this.gcMetrics.metrics.gcMinor;\n  metrics.gcIncrementalDuration = this.gcMetrics.metrics.gcIncremental;\n  metrics.gcWeakCBDuration = this.gcMetrics.metrics.gcWeakCB;\n  this.gcMetrics.reset();\n  const driverMetrics = getMongoDriverStats();\n  resetMongoDriverStats();\n  metrics.mongoPoolSize = driverMetrics.poolSize;\n  metrics.mongoPoolPrimaryCheckouts = driverMetrics.primaryCheckouts;\n  metrics.mongoPoolOtherCheckouts = driverMetrics.otherCheckouts;\n  metrics.mongoPoolCheckoutTime = driverMetrics.checkoutTime;\n  metrics.mongoPoolMaxCheckoutTime = driverMetrics.maxCheckoutTime;\n  metrics.mongoPoolPending = driverMetrics.pending;\n  metrics.mongoPoolCheckedOutConnections = driverMetrics.checkedOut;\n  metrics.mongoPoolCreatedConnections = driverMetrics.created;\n  const fiberMetrics = getFiberMetrics();\n  resetFiberMetrics();\n  metrics.createdFibers = fiberMetrics.created;\n  metrics.activeFibers = fiberMetrics.active;\n  metrics.fiberPoolSize = fiberMetrics.poolSize;\n  metrics.pcpu = 0;\n  metrics.pcpuUser = 0;\n  metrics.pcpuSystem = 0;\n  if (this.cpuHistory.length > 0) {\n    let lastCpuUsage = this.cpuHistory[this.cpuHistory.length - 1];\n    metrics.pcpu = lastCpuUsage.usage * 100;\n    metrics.pcpuUser = lastCpuUsage.user * 100;\n    metrics.pcpuSystem = lastCpuUsage.sys * 100;\n  }\n  metrics.cpuHistory = this.cpuHistory.map(entry => ({\n    time: Kadira.syncedDate.syncTime(entry.time),\n    usage: entry.usage,\n    sys: entry.sys,\n    user: entry.user\n  }));\n  this.cpuHistory = [];\n  this.startTime = now;\n  return {\n    systemMetrics: [metrics]\n  };\n};\nfunction hrtimeToMS(hrtime) {\n  return hrtime[0] * 1000 + hrtime[1] / 1000000;\n}\nSystemModel.prototype.cpuUsage = function () {\n  let elapTimeMS = hrtimeToMS(process.hrtime(this.cpuTime));\n  let elapUsage = process.cpuUsage(this.previousCpuUsage);\n  let elapUserMS = elapUsage.user / 1000;\n  let elapSystMS = elapUsage.system / 1000;\n  let totalUsageMS = elapUserMS + elapSystMS;\n  let totalUsagePercent = totalUsageMS / elapTimeMS;\n  this.cpuHistory.push({\n    time: Ntp._now(),\n    usage: totalUsagePercent,\n    user: elapUserMS / elapTimeMS,\n    sys: elapSystMS / elapUsage.system\n  });\n  this.currentCpuUsage = totalUsagePercent * 100;\n  Kadira.docSzCache.setPcpu(this.currentCpuUsage);\n  this.cpuTime = process.hrtime();\n  this.previousCpuUsage = process.cpuUsage();\n};\nSystemModel.prototype.handleSessionActivity = function (msg, session) {\n  if (msg.msg === 'connect' && !msg.session) {\n    this.countNewSession(session);\n  } else if (['sub', 'method'].indexOf(msg.msg) !== -1) {\n    if (!this.isSessionActive(session)) {\n      this.countNewSession(session);\n    }\n  }\n  session._activeAt = Date.now();\n};\nSystemModel.prototype.countNewSession = function (session) {\n  if (!isLocalAddress(session.socket)) {\n    this.newSessions++;\n  }\n};\nSystemModel.prototype.isSessionActive = function (session) {\n  let inactiveTime = Date.now() - session._activeAt;\n  return inactiveTime < this.sessionTimeout;\n};\n\n// ------------------------------------------------------------------------- //\n\n// http://regex101.com/r/iF3yR3/2\n// eslint-disable-next-line no-useless-escape\nlet isLocalHostRegex = /^(?:.*\\.local|localhost)(?:\\:\\d+)?|127(?:\\.\\d{1,3}){3}|192\\.168(?:\\.\\d{1,3}){2}|10(?:\\.\\d{1,3}){3}|172\\.(?:1[6-9]|2\\d|3[0-1])(?:\\.\\d{1,3}){2}$/;\n\n// http://regex101.com/r/hM5gD8/1\nlet isLocalAddressRegex = /^127(?:\\.\\d{1,3}){3}|192\\.168(?:\\.\\d{1,3}){2}|10(?:\\.\\d{1,3}){3}|172\\.(?:1[6-9]|2\\d|3[0-1])(?:\\.\\d{1,3}){2}$/;\nfunction isLocalAddress(socket) {\n  let host = socket.headers['host'];\n  if (host) {\n    return isLocalHostRegex.test(host);\n  }\n  let address = socket.headers['x-forwarded-for'] || socket.remoteAddress;\n  if (address) {\n    return isLocalAddressRegex.test(address);\n  }\n}","map":{"version":3,"names":["module","export","SystemModel","_","link","v","Meteor","countKeys","createHistogram","GCMetrics","default","getFiberMetrics","resetFiberMetrics","getMongoDriverStats","resetMongoDriverStats","KadiraModel","EventLoopMonitor","Ntp","startTime","_now","newSessions","sessionTimeout","evloopHistogram","evloopMonitor","start","on","lag","add","gcMetrics","cpuTime","process","hrtime","previousCpuUsage","cpuUsage","cpuHistory","currentCpuUsage","setInterval","extend","prototype","buildPayload","metrics","now","Kadira","syncedDate","syncTime","endTime","sessions","server","memoryUsage","memory","rss","memoryArrayBuffers","arrayBuffers","memoryExternal","external","memoryHeapUsed","heapUsed","memoryHeapTotal","heapTotal","activeRequests","_getActiveRequests","length","activeHandles","_getActiveHandles","pctEvloopBlock","status","pctBlock","gcMajorDuration","gcMajor","gcMinorDuration","gcMinor","gcIncrementalDuration","gcIncremental","gcWeakCBDuration","gcWeakCB","reset","driverMetrics","mongoPoolSize","poolSize","mongoPoolPrimaryCheckouts","primaryCheckouts","mongoPoolOtherCheckouts","otherCheckouts","mongoPoolCheckoutTime","checkoutTime","mongoPoolMaxCheckoutTime","maxCheckoutTime","mongoPoolPending","pending","mongoPoolCheckedOutConnections","checkedOut","mongoPoolCreatedConnections","created","fiberMetrics","createdFibers","activeFibers","active","fiberPoolSize","pcpu","pcpuUser","pcpuSystem","lastCpuUsage","usage","user","sys","map","entry","time","systemMetrics","hrtimeToMS","elapTimeMS","elapUsage","elapUserMS","elapSystMS","system","totalUsageMS","totalUsagePercent","push","docSzCache","setPcpu","handleSessionActivity","msg","session","countNewSession","indexOf","isSessionActive","_activeAt","Date","isLocalAddress","socket","inactiveTime","isLocalHostRegex","isLocalAddressRegex","host","headers","test","address","remoteAddress"],"sources":["packages/montiapm:agent/lib/models/system.js"],"sourcesContent":["import { _ } from 'meteor/underscore';\nimport { Meteor } from 'meteor/meteor';\nimport { countKeys, createHistogram } from '../utils.js';\nimport GCMetrics from '../hijack/gc.js';\nimport { getFiberMetrics, resetFiberMetrics } from '../hijack/async.js';\nimport { getMongoDriverStats, resetMongoDriverStats } from '../hijack/mongo_driver_events.js';\nimport { KadiraModel } from './0model';\nimport { EventLoopMonitor } from '../event_loop_monitor.js';\nimport { Ntp } from '../ntp';\n\nexport function SystemModel () {\n  this.startTime = Ntp._now();\n  this.newSessions = 0;\n  // 30 min\n  this.sessionTimeout = 1000 * 60 * 30;\n\n  this.evloopHistogram = createHistogram();\n  this.evloopMonitor = new EventLoopMonitor(200);\n  this.evloopMonitor.start();\n  this.evloopMonitor.on('lag', lag => {\n    // store as microsecond\n    this.evloopHistogram.add(lag * 1000);\n  });\n\n  this.gcMetrics = new GCMetrics();\n  this.gcMetrics.start();\n\n\n  this.cpuTime = process.hrtime();\n  this.previousCpuUsage = process.cpuUsage();\n  this.cpuHistory = [];\n  this.currentCpuUsage = 0;\n\n  setInterval(() => {\n    this.cpuUsage();\n  }, 2000);\n}\n\n_.extend(SystemModel.prototype, KadiraModel.prototype);\n\nSystemModel.prototype.buildPayload = function () {\n  let metrics = {};\n  let now = Ntp._now();\n  metrics.startTime = Kadira.syncedDate.syncTime(this.startTime);\n  metrics.endTime = Kadira.syncedDate.syncTime(now);\n  metrics.sessions = countKeys(Meteor.server.sessions);\n\n  let memoryUsage = process.memoryUsage();\n  metrics.memory = memoryUsage.rss / (1024 * 1024);\n  metrics.memoryArrayBuffers = (memoryUsage.arrayBuffers || 0) / (1024 * 1024);\n  metrics.memoryExternal = memoryUsage.external / (1024 * 1024);\n  metrics.memoryHeapUsed = memoryUsage.heapUsed / (1024 * 1024);\n  metrics.memoryHeapTotal = memoryUsage.heapTotal / (1024 * 1024);\n\n  metrics.newSessions = this.newSessions;\n  this.newSessions = 0;\n\n  metrics.activeRequests = process._getActiveRequests().length;\n  metrics.activeHandles = process._getActiveHandles().length;\n\n  // track eventloop metrics\n  metrics.pctEvloopBlock = this.evloopMonitor.status().pctBlock;\n  metrics.evloopHistogram = this.evloopHistogram;\n  this.evloopHistogram = createHistogram();\n\n  metrics.gcMajorDuration = this.gcMetrics.metrics.gcMajor;\n  metrics.gcMinorDuration = this.gcMetrics.metrics.gcMinor;\n  metrics.gcIncrementalDuration = this.gcMetrics.metrics.gcIncremental;\n  metrics.gcWeakCBDuration = this.gcMetrics.metrics.gcWeakCB;\n  this.gcMetrics.reset();\n\n  const driverMetrics = getMongoDriverStats();\n  resetMongoDriverStats();\n\n  metrics.mongoPoolSize = driverMetrics.poolSize;\n  metrics.mongoPoolPrimaryCheckouts = driverMetrics.primaryCheckouts;\n  metrics.mongoPoolOtherCheckouts = driverMetrics.otherCheckouts;\n  metrics.mongoPoolCheckoutTime = driverMetrics.checkoutTime;\n  metrics.mongoPoolMaxCheckoutTime = driverMetrics.maxCheckoutTime;\n  metrics.mongoPoolPending = driverMetrics.pending;\n  metrics.mongoPoolCheckedOutConnections = driverMetrics.checkedOut;\n  metrics.mongoPoolCreatedConnections = driverMetrics.created;\n\n  const fiberMetrics = getFiberMetrics();\n  resetFiberMetrics();\n  metrics.createdFibers = fiberMetrics.created;\n  metrics.activeFibers = fiberMetrics.active;\n  metrics.fiberPoolSize = fiberMetrics.poolSize;\n\n  metrics.pcpu = 0;\n  metrics.pcpuUser = 0;\n  metrics.pcpuSystem = 0;\n\n  if (this.cpuHistory.length > 0) {\n    let lastCpuUsage = this.cpuHistory[this.cpuHistory.length - 1];\n    metrics.pcpu = lastCpuUsage.usage * 100;\n    metrics.pcpuUser = lastCpuUsage.user * 100;\n    metrics.pcpuSystem = lastCpuUsage.sys * 100;\n  }\n\n  metrics.cpuHistory = this.cpuHistory.map(entry => ({\n    time: Kadira.syncedDate.syncTime(entry.time),\n    usage: entry.usage,\n    sys: entry.sys,\n    user: entry.user\n  }));\n\n  this.cpuHistory = [];\n  this.startTime = now;\n  return {systemMetrics: [metrics]};\n};\n\nfunction hrtimeToMS (hrtime) {\n  return hrtime[0] * 1000 + hrtime[1] / 1000000;\n}\n\nSystemModel.prototype.cpuUsage = function () {\n  let elapTimeMS = hrtimeToMS(process.hrtime(this.cpuTime));\n  let elapUsage = process.cpuUsage(this.previousCpuUsage);\n  let elapUserMS = elapUsage.user / 1000;\n  let elapSystMS = elapUsage.system / 1000;\n  let totalUsageMS = elapUserMS + elapSystMS;\n  let totalUsagePercent = totalUsageMS / elapTimeMS;\n\n  this.cpuHistory.push({\n    time: Ntp._now(),\n    usage: totalUsagePercent,\n    user: elapUserMS / elapTimeMS,\n    sys: elapSystMS / elapUsage.system\n  });\n\n  this.currentCpuUsage = totalUsagePercent * 100;\n  Kadira.docSzCache.setPcpu(this.currentCpuUsage);\n\n  this.cpuTime = process.hrtime();\n  this.previousCpuUsage = process.cpuUsage();\n};\n\nSystemModel.prototype.handleSessionActivity = function (msg, session) {\n  if (msg.msg === 'connect' && !msg.session) {\n    this.countNewSession(session);\n  } else if (['sub', 'method'].indexOf(msg.msg) !== -1) {\n    if (!this.isSessionActive(session)) {\n      this.countNewSession(session);\n    }\n  }\n  session._activeAt = Date.now();\n};\n\nSystemModel.prototype.countNewSession = function (session) {\n  if (!isLocalAddress(session.socket)) {\n    this.newSessions++;\n  }\n};\n\nSystemModel.prototype.isSessionActive = function (session) {\n  let inactiveTime = Date.now() - session._activeAt;\n  return inactiveTime < this.sessionTimeout;\n};\n\n// ------------------------------------------------------------------------- //\n\n// http://regex101.com/r/iF3yR3/2\n// eslint-disable-next-line no-useless-escape\nlet isLocalHostRegex = /^(?:.*\\.local|localhost)(?:\\:\\d+)?|127(?:\\.\\d{1,3}){3}|192\\.168(?:\\.\\d{1,3}){2}|10(?:\\.\\d{1,3}){3}|172\\.(?:1[6-9]|2\\d|3[0-1])(?:\\.\\d{1,3}){2}$/;\n\n// http://regex101.com/r/hM5gD8/1\nlet isLocalAddressRegex = /^127(?:\\.\\d{1,3}){3}|192\\.168(?:\\.\\d{1,3}){2}|10(?:\\.\\d{1,3}){3}|172\\.(?:1[6-9]|2\\d|3[0-1])(?:\\.\\d{1,3}){2}$/;\n\nfunction isLocalAddress (socket) {\n  let host = socket.headers['host'];\n  if (host) {\n    return isLocalHostRegex.test(host);\n  }\n  let address = socket.headers['x-forwarded-for'] || socket.remoteAddress;\n  if (address) {\n    return isLocalAddressRegex.test(address);\n  }\n}\n"],"mappings":"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"},"sourceType":"module","externalDependencies":{},"hash":"644899b8717de8d7543d8c43793c74ee4586a4c1"}
